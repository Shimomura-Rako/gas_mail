<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>~pamoka~ DMMè‹±ä¼šè©± äºˆç´„é€šçŸ¥ãƒ„ãƒ¼ãƒ«ï¼ˆéå…¬å¼ï¼‰</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.8; color: #333; max-width: 800px; margin: auto; padding: 30px; background-color: #fff0f5; }
        h1 { color: #d81b60; text-align: center; border-bottom: 3px solid #d81b60; padding-bottom: 10px; }
        h2 { color: #ad1457; background: #fce4ec; padding: 10px; border-left: 5px solid #ad1457; margin-top: 30px; }
        .step { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .pink-text { color: #d81b60; font-weight: bold; }
        code { background: #eee; padding: 2px 5px; border-radius: 4px; font-weight: bold; }
        img { width: 100%; max-width: 500px; display: block; margin: 10px auto; border: 2px solid #ffc1e3; border-radius: 8px; }
        .copy-btn { background-color: #d81b60; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em; margin: 15px 0; transition: 0.3s; }
        .copy-btn:hover { background-color: #ad1457; }
    </style>
</head>
<body>
    <h1>~pamoka~ DMMè‹±ä¼šè©± äºˆç´„é€šçŸ¥ãƒ„ãƒ¼ãƒ«ï¼ˆéå…¬å¼ï¼‰</h1>
    <p>pamokaã¯ã€DMMè‹±ä¼šè©±ã®è¬›å¸«ãƒšãƒ¼ã‚¸ã‚’å®šæœŸãƒã‚§ãƒƒã‚¯ã—ã¦ã€Œäºˆç´„å¯ã€ãŒå¢—ãˆãŸã¨ãã«é€šçŸ¥ã™ã‚‹ã€å€‹äººé–‹ç™ºã®ç„¡æ–™ã‚µãƒãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«ã§ã™ï¼ˆéå…¬å¼ï¼‰<br>
    ç™»éŒ²ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ãŒå±Šãã¾ã™ï¼<br>
    ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€Googleã®GAS(Google Apps Script)ã®è¨­å®šæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™</p>

    <div class="step">
        <h2>0. äº‹å‰æº–å‚™</h2>
        <ul>
            <li><strong>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</strong>ï¼ˆæŒã£ã¦ã„ãªã„äººã¯ <a href="https://accounts.google.com/signup" target="_blank">ã“ã“ã‹ã‚‰ç„¡æ–™ã§ä½œæˆ</a> ã—ã¦ã­ï¼ï¼‰</li>
            <li><strong>DMMè‹±ä¼šè©±ã®è¬›å¸«ç•ªå·</strong></li>
        </ul>
        <p style="font-size: 0.9em; color: #666;">â€»è¬›å¸«ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã®URLã®ä¸€ç•ªæœ€å¾Œã«ã‚ã‚‹æ•°å­—ã§ã™ã€‚ä¸‹ã®ç”»åƒã‚’å‚è€ƒã«ã—ã¦ã­</p>
        <img src="step0_teacher_id.png" alt="è¬›å¸«ç•ªå·ã®ç¢ºèªæ–¹æ³•">
    </div>

    <div class="step">
        <h2>1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æº–å‚™ã™ã‚‹</h2>
        <p>ã¾ãšã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã™ã‚‹ã€Œå°å¸³ã€ã‚’ä½œã‚Šã¾ã™ã€‚</p>
        <p class="pink-text">ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®é–‹ãæ–¹ã€‘</p>
        <p>Googleã®ç”»é¢å³ä¸Šã«ã‚ã‚‹ã€Œç‚¹ã€…ã®ãƒãƒ¼ã‚¯ã€ã‹ã‚‰ã€ç·‘è‰²ã®<strong>ã€Œã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã€</strong>ã‚’é¸ã‚“ã§ã­ã€‚</p>
        <img src="step1.jpg" alt="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®é–‹ãæ–¹">
        <p>é–‹ã„ãŸã‚‰ã€Œç©ºç™½ï¼ˆï¼‹ãƒãƒ¼ã‚¯ï¼‰ã€ã‚’æŠ¼ã—ã¦æ–°ã—ã„ã‚·ãƒ¼ãƒˆã‚’ä½œã‚‹ã ã‘ã§æº–å‚™å®Œäº†ï¼</p>
        <img src="step1_2.png" alt="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®é–‹ãæ–¹ï¼’">
        <p class="pink-text">â€»ã‚·ãƒ¼ãƒˆã«ã¯ä½•ã‚‚æ›¸ã‹ãªãã¦å¤§ä¸ˆå¤«ã€‚</p>
    </div>

    <div class="step">
        <h2>2. ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’è²¼ã‚Šä»˜ã‘ã‚‹</h2>
        <p>1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€â†’ã€ŒApps Scriptã€ã‚’é¸ã‚“ã§ã­ã€‚</p>
        <p>2. ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã­ã€‚</p>
        
        <button class="copy-btn" onclick="copyGasCode()">ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ ğŸ“‹</button>
        
        <p>3. å…ƒã‹ã‚‰æ›¸ã„ã¦ã‚ã‚‹æ–‡å­—ã‚’å…¨éƒ¨æ¶ˆã—ã¦ã€è²¼ã‚Šä»˜ã‘ï¼ˆCtrl + Vï¼‰ã¦ã­ï¼</p>
        <p class="pink-text">4. ã‚³ãƒ¼ãƒ‰ã®ä¸€ç•ªä¸Šã«ã‚ã‚‹ã€Œãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãªã©ã‚’ã€è‡ªåˆ†ã®ã‚‚ã®ã«æ›¸ãæ›ãˆã¦ä¿å­˜ã—ã¦ã­ã€‚</p>
    </div>

    <div class="step">
        <h2>3. ä»•ä¸Šã’ï¼ˆãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼‰</h2>
        <p>æœ€å¾Œã«<code>setupTrigger</code>ã¨ã„ã†é–¢æ•°ã‚’é¸ã‚“ã§å®Ÿè¡Œï¼ã“ã‚Œã§è‡ªå‹•ç›£è¦–ãŒã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚</p>
    </div>

    <footer style="text-align: center; margin-top: 50px; color: #888;">
        Created by pamoka
    </footer>

    <textarea id="gasCodeHidden" style="position: absolute; left: -9999px;">
// ==========================================
// è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã“ã“ã ã‘æ›¸ãæ›ãˆã¦ã­ï¼‰
// ==========================================
const SHEET_ID = "ã“ã“ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®IDã‚’è²¼ã£ã¦ã­"; 
const NOTIFICATION_EMAIL = "xxxxxxxxxxxxx@gmail.comï¼ˆã“ã“ã«ã‚ãªãŸã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥ã‚Œã¦ã­ï¼‰"; 
const CHECK_INTERVAL_MINUTES = 10; 
const SHEET_NAME = "ã‚·ãƒ¼ãƒˆ1";

function setup() {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheets()[0];
  if (sheet.getRange("A1").getValue() === "") {
    sheet.getRange("A1:C1").setValues([["è¬›å¸«ç•ªå·", "åå‰", "äºˆç´„å¯æ•°"]]);
    sheet.getRange("A1:C1").setBackground("#ffe0f0").setFontWeight("bold");
    Browser.msgBox("å°å¸³ã®æº–å‚™ãŒã§ãã¾ã—ãŸï¼Aåˆ—ã«è¬›å¸«ç•ªå·ã‚’å…¥åŠ›ã—ã¦ã­ã€‚");
  }
}

function checkTeacherAvailability() {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      const teacherId = String(data[i][0]).trim();
      let teacherName = String(data[i][1]).trim();
      const lastCount = data[i][2] === "" ? null : Number(data[i][2]);
      if (!teacherId || teacherId === "") continue; 
      try {
        const url = `https://eikaiwa.dmm.com/teacher/index/${teacherId}/`;
        const response = UrlFetchApp.fetch(url, {
          muteHttpExceptions: true,
          headers: { "User-Agent": "Mozilla/5.0" },
          timeout: 10000
        });
        if (response.getResponseCode() !== 200) continue;
        const html = response.getContentText();
        if (!teacherName || teacherName === "" || teacherName === "undefined") {
          const titleMatch = html.match(/<title>([\s\S]*?)\s-\sDMMè‹±ä¼šè©±<\/title>/i);
          teacherName = (titleMatch && titleMatch[1]) ? titleMatch[1].trim() : "è¬›å¸« " + teacherId;
          sheet.getRange(i + 1, 2).setValue(teacherName);
          sendRegistrationNotice(teacherId, teacherName);
        }
        const matches = html.match(/äºˆç´„å¯/g);
        const currentCount = matches ? matches.length : 0;
        if (lastCount !== null && currentCount > lastCount) {
          sendNotification(teacherId, teacherName, lastCount, currentCount);
        }
        sheet.getRange(i + 1, 3).setValue(currentCount);
        Utilities.sleep(1000);
      } catch (e) { console.error(e); }
    }
  } catch (e) { Logger.log(e); }
}

function sendRegistrationNotice(teacherId, teacherName) {
  const subject = `ã€ç›£è¦–é–‹å§‹ã€‘${teacherName}ã‚’ãƒªã‚¹ãƒˆã«ç™»éŒ²ã—ãŸã‚ˆï¼`;
  const message = `æ–°ã—ã„è¬›å¸«ã€Œ${teacherName}ï¼ˆ${teacherId}ï¼‰ã€ã®10åˆ†ãŠãç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼`;
  GmailApp.sendEmail(NOTIFICATION_EMAIL, subject, message);
}

function sendNotification(teacherId, teacherName, prevCount, currentCount) {
  const subject = `ã€DMMè‹±ä¼šè©±ã€‘${teacherName}ï¼ˆ${teacherId}ï¼‰ãƒ¬ãƒƒã‚¹ãƒ³é–‹è¬›é€šçŸ¥`;
  const message = `${teacherName}ã«ãƒ¬ãƒƒã‚¹ãƒ³äºˆç´„æ ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼\nå‰å›: ${prevCount}ä»¶ â†’ ç¾åœ¨: ${currentCount}ä»¶\nhttps://eikaiwa.dmm.com/teacher/index/${teacherId}/`;
  GmailApp.sendEmail(NOTIFICATION_EMAIL, subject, message);
}

function setupTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
  ScriptApp.newTrigger("checkTeacherAvailability").timeBased().everyMinutes(CHECK_INTERVAL_MINUTES).create();
  Logger.log("â° ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼");
}</textarea>

    <script>
        function copyGasCode() {
            const copyText = document.getElementById("gasCodeHidden");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            document.execCommand("copy");
            alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼Apps Scriptã®ç”»é¢ã«è²¼ã‚Šä»˜ã‘ã¦ã­ã€‚");
        }
    </script>
</body>
</html>
