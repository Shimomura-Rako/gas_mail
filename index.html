<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>~pamoka~ DMMè‹±ä¼šè©± äºˆç´„é€šçŸ¥ãƒ„ãƒ¼ãƒ«ï¼ˆéå…¬å¼ï¼‰</title>
    <style>
        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            line-height: 1.8; 
            color: #333; 
            background-image: url('bkg.png'); 
            background-size: cover; 
            background-attachment: fixed; 
            background-position: center;
            margin: 0;
            padding: 40px 20px; 
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 1000px; 
            width: 100%;
            background-color: rgba(255, 255, 255, 0.95); 
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
        }

        h1 { color: #2e7d32; text-align: center; border-bottom: 3px solid #2e7d32; padding-bottom: 10px; margin-top: 0; }
        h2 { color: #1b5e20; background: #e8f5e9; padding: 10px; border-left: 5px solid #2e7d32; margin-top: 30px; }
        
        .step { 
            background: #ffffff; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .pink-text { color: #2e7d32; font-weight: bold; }
        code { background: #eee; padding: 2px 5px; border-radius: 4px; font-weight: bold; }
        
        img { width: 100%; max-width: 600px; display: block; margin: 15px auto; border: 2px solid #c8e6c9; border-radius: 8px; }
        
        .copy-btn { 
            background-color: #4caf50; color: white; border: none; padding: 12px 24px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em; 
            margin: 15px 0; transition: 0.3s; width: 100%; max-width: 300px; display: block; margin-left: auto; margin-right: auto;
        }
        .copy-btn:hover { background-color: #388e3c; }
        
        footer { text-align: center; margin-top: 50px; color: #888; font-size: 0.9em; }
    </style>
</head>

<body>
    <div class="container">
        <h1>~pamoka~ DMMè‹±ä¼šè©± äºˆç´„é€šçŸ¥ãƒ„ãƒ¼ãƒ«ï¼ˆéå…¬å¼ï¼‰</h1>
        <p>pamokaã¯ã€DMMè‹±ä¼šè©±ã®è¬›å¸«ãƒšãƒ¼ã‚¸ã‚’å®šæœŸãƒã‚§ãƒƒã‚¯ã—ã¦ã€Œäºˆç´„å¯ã€ãŒå¢—ãˆãŸã¨ãã«é€šçŸ¥ã™ã‚‹ã€å€‹äººé–‹ç™ºã®ç„¡æ–™ã‚µãƒãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ç™»éŒ²ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ãŒå±Šãã¾ã™ã€‚</p>

        <div class="step">
            <h2>0. äº‹å‰æº–å‚™</h2>
            <ul>
                <li><strong>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</strong></li>
                <li><strong>DMMè‹±ä¼šè©±ã®è¬›å¸«ç•ªå·</strong></li>
            </ul>
            <img src="step0_teacher_id.png" alt="è¬›å¸«ç•ªå·ã®ç¢ºèªæ–¹æ³•">
        </div>

        <div class="step">
            <h2>1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æº–å‚™ã™ã‚‹</h2>
            <img src="step1_where_spreadsheet.png" alt="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®é–‹ãæ–¹">
            <img src="step1_spreadsheet.png" alt="æ–°ã—ã„ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ">
        </div>

        <div class="step">
            <h2>2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’ãƒ¡ãƒ¢ã™ã‚‹</h2>
            <p>â€»ä»Šå›ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã€ã“ã®IDã‚’ç›´æ¥ã‚³ãƒ¼ãƒ‰ã«è²¼ã‚Šä»˜ã‘ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€å ´æ‰€ã‚’çŸ¥ã£ã¦ãŠãã¨å®‰å¿ƒã§ã™ã€‚</p>
            <img src="sheet_id.png" alt="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã®å ´æ‰€">
        </div>

        <div class="step">
            <h2>3. ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’è²¼ã‚Šä»˜ã‘ã‚‹</h2>
            <p>ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€â†’ã€ŒApps Scriptã€ã‚’é¸ã³ã€å…ƒã®æ–‡å­—ã‚’å…¨éƒ¨æ¶ˆã—ã¦ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
            <button class="copy-btn" onclick="copyGasCode()">ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ ğŸ“‹</button>
            <img src="gas_paste.png" alt="GASã®ç”»é¢ã«è²¼ã‚Šä»˜ã‘">
        </div>

        <div class="step">
            <h2>4. ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹</h2>
            <p>ãƒ•ãƒ­ãƒƒãƒ”ãƒ¼ã®ãƒãƒ¼ã‚¯ã‚’æŠ¼ã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ã—ã¾ã™ã€‚<strong>â€»ã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ›ãˆã¯ä¸è¦ã§ã™ï¼</strong></p>
            <img src="save.png" alt="GASã®ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹ãƒœã‚¿ãƒ³">
        </div>

        <div class="step">
            <h2>5. åˆæœŸè¨­å®š(setup)ã‚’å®Ÿè¡Œã™ã‚‹</h2>
            <p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ <code>setup</code> ã‚’é¸ã‚“ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚æ‰¿èªç”»é¢ã¯ã€Œè©³ç´°ã€ã‹ã‚‰é€²ã‚ã¦è¨±å¯ã—ã¦ãã ã•ã„ã€‚</p>
            <img src="gas_setup_select.png" alt="setupé–¢æ•°ã®é¸æŠ">
        </div>

        <div class="step">
            <h2>6. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨è¬›å¸«ç•ªå·ã‚’ç™»éŒ²ã™ã‚‹</h2>
            <p>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æˆ»ã‚‹ã¨å…¥åŠ›æ¬„ãŒã§ãã¦ã„ã¾ã™ã€‚B1ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€5è¡Œç›®ã‹ã‚‰è¬›å¸«ç•ªå·ã‚’å…¥åŠ›ã—ã¾ã™ã€‚</p>
            <img src="input.png" alt="è¬›å¸«ç•ªå·å…¥åŠ›">
        </div>

        <div class="step">
            <h2>7. å®šæœŸè‡ªå‹•ç›£è¦–(setupTrigger)ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆ</h2>
            <p>GASã«æˆ»ã‚Šã€<code>setupTrigger</code> ã‚’é¸æŠã—ã¦å®Ÿè¡Œã™ã‚Œã°å®Œäº†ã§ã™ï¼</p>
            <img src="run2.png" alt="setupTriggerã‚’é¸æŠã—ã¦ã„ã‚‹æ§˜å­">
        </div>

        <footer>
            Created by pamoka
        </footer>
    </div>

    <textarea id="gasCodeHidden" style="position: absolute; left: -9999px;">
/**
 * DMMè‹±ä¼šè©± äºˆç´„ç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (pamokaç‰ˆ)
 */

function setup() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
  
  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’è‡ªå‹•ä½œæˆ
  sheet.getRange("A1").setValue("ã€è¨­å®šã€‘é€šçŸ¥ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š").setBackground("#f1f8e9").setFontWeight("bold");
  sheet.getRange("B1").setBackground("#fff9c4").setBorder(true, true, true, true, false, false);
  sheet.getRange("A2").setValue("â€»B1ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€A5ã‹ã‚‰è¬›å¸«ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„").setFontColor("#666").setFontSize(9);

  sheet.getRange("A4:C4").setValues([["è¬›å¸«ç•ªå·", "åå‰", "äºˆç´„å¯æ•°"]]);
  sheet.getRange("A4:C4").setBackground("#e8f5e9").setFontWeight("bold");
  
  Browser.msgBox("æº–å‚™å®Œäº†ï¼\\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ã€æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
}

function checkTeacherAvailability() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
  const email = sheet.getRange("B1").getValue();
  
  if (!email || !email.includes("@")) return;

  const lastRow = sheet.getLastRow();
  if (lastRow < 5) return;

  const data = sheet.getRange(5, 1, lastRow - 4, 3).getValues();
  
  for (let i = 0; i < data.length; i++) {
    const teacherId = String(data[i][0]).trim();
    let teacherName = String(data[i][1]).trim();
    const lastCount = data[i][2] === "" ? null : Number(data[i][2]);
    
    if (!teacherId) continue;

    try {
      const url = "https://eikaiwa.dmm.com/teacher/index/" + teacherId + "/";
      const response = UrlFetchApp.fetch(url, {
        muteHttpExceptions: true,
        headers: { "User-Agent": "Mozilla/5.0" }
      });

      if (response.getResponseCode() !== 200) continue;
      const html = response.getContentText();

      // åå‰å–å¾—ï¼†ã€Œã®è¬›å¸«è©³ç´°ã€å‰Šé™¤
      if (!teacherName || teacherName === "" || teacherName.includes("è¬›å¸«è©³ç´°")) {
        const titleMatch = html.match(/<title>([\s\S]*?)\s-\sDMMè‹±ä¼šè©±<\/title>/i);
        if (titleMatch && titleMatch[1]) {
          teacherName = titleMatch[1].replace("ã®è¬›å¸«è©³ç´°", "").trim();
        } else {
          teacherName = "è¬›å¸« " + teacherId;
        }
        sheet.getRange(i + 5, 2).setValue(teacherName);
      }

      const matches = html.match(/äºˆç´„å¯/g);
      let currentCount = Math.max(0, (matches ? matches.length : 0) - 2);

      // é€šçŸ¥åˆ¤å®šï¼ˆç™»éŒ²æ™‚é€šçŸ¥ã‚’ç¶­æŒï¼‰
      if (lastCount === null) {
        sendNotification(email, teacherId, teacherName, currentCount, true);
      } else if (currentCount > lastCount) {
        sendNotification(email, teacherId, teacherName, currentCount, false);
      }

      sheet.getRange(i + 5, 3).setValue(currentCount);
      Utilities.sleep(1000);

    } catch (e) { console.error(e); }
  }
}

function sendNotification(email, teacherId, teacherName, currentCount, isFirstTime) {
  let subject, message;
  if (isFirstTime) {
    subject = "ã€DMMé€šçŸ¥ã€‘ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼ˆ" + teacherName + "å…ˆç”Ÿï¼‰";
    message = teacherName + "å…ˆç”Ÿï¼ˆID:" + teacherId + "ï¼‰ã®äºˆç´„ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚\\nç¾åœ¨ã®ç©ºãçŠ¶æ³ï¼š" + currentCount + "ä»¶\\n\\nhttps://eikaiwa.dmm.com/teacher/index/" + teacherId + "/";
  } else {
    subject = "ã€DMMé€šçŸ¥ã€‘" + teacherName + "å…ˆç”Ÿã®ç©ºããŒå‡ºã¾ã—ãŸ";
    message = teacherName + "å…ˆç”Ÿã®äºˆç´„æ ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼\\nç¾åœ¨ã®ç©ºãçŠ¶æ³ï¼š" + currentCount + "ä»¶\\n\\nhttps://eikaiwa.dmm.com/teacher/index/" + teacherId + "/";
  }
  GmailApp.sendEmail(email, subject, message);
}

function setupTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
  ScriptApp.newTrigger("checkTeacherAvailability").timeBased().everyMinutes(10).create();
}
</textarea>

    <script>
        function copyGasCode() {
            const copyText = document.getElementById("gasCodeHidden");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            document.execCommand("copy");
            alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
        }
    </script>
</body>
</html>
