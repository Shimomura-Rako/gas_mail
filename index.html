<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>~pamoka~ DMM英会話 予約通知ツール（非公式）</title>
<link rel="icon" href="favicon.ico">

<meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="~pamoka~ DMM英会話 予約通知ツール（非公式）">
    <meta name="twitter:description" content="お気に入り講師の予約空きを自動でチェックしてメールでお知らせ！完全無料で使えるサポートツールです。">
    <meta name="twitter:image" content="https://pamoka-gas-tutorial.onrender.com/og-image.png">


    <style>
        /* 背景画像をbkg.pngに設定 */
        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            line-height: 1.8; 
            color: #333; 
            background-image: url('bkg.png'); 
            background-size: cover; 
            background-attachment: fixed; 
            background-position: center;
            margin: 0;
            padding: 40px 20px; 
            display: flex;
            justify-content: center;
        }

        /* 記事本体：白いカード */
        .container {
            max-width: 1000px; 
            width: 100%;
            background-color: rgba(255, 255, 255, 0.95); 
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
        }

        /* タイトルと見出しの色をグリーンに変更 */
        h1 { color: #2e7d32; text-align: center; border-bottom: 3px solid #2e7d32; padding-bottom: 10px; margin-top: 0; }
        h2 { color: #1b5e20; background: #e8f5e9; padding: 10px; border-left: 5px solid #2e7d32; margin-top: 30px; }
        
        .step { 
            background: #ffffff; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* 強調テキストの色をグリーンに変更 */
        .pink-text { color: #2e7d32; font-weight: bold; }
        code { background: #eee; padding: 2px 5px; border-radius: 4px; font-weight: bold; }
        
        /* 画像の枠線をグリーンに変更 */
        img { width: 100%; max-width: 600px; display: block; margin: 15px auto; border: 2px solid #c8e6c9; border-radius: 8px; }
        
        /* コピーボタンの色をグリーンに変更 */
        .copy-btn { 
            background-color: #4caf50; color: white; border: none; padding: 12px 24px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em; 
            margin: 15px 0; transition: 0.3s; width: 100%; max-width: 300px; display: block; margin-left: auto; margin-right: auto;
        }
        .copy-btn:hover { background-color: #388e3c; }
        
        footer { text-align: center; margin-top: 50px; color: #888; font-size: 0.9em; }

/* スマホ（画面幅768px以下）用の調整よ */
@media (max-width: 768px) {
    body {
        padding: 10px; /* 周りの余白を削ってスッキリさせるわ */
    }
    .container {
        padding: 20px; /* カードの中の余白も少し詰めるわよ */
    }
    h1 {
        font-size: 1.5rem; /* タイトルの字を少し小さく */
    }
    h2 {
        font-size: 1.2rem; /* 見出しも合わせて調整 */
    }
}



    </style>
</head>

<body>
    <div class="container">
        <h1>~pamoka~ DMM英会話 予約通知ツール（非公式）</h1>
        <p>pamokaは、DMM英会話の講師ページを定期チェックして「予約可」が増えたときに通知する、個人開発の無料サポートツールです（非公式）。登録したアドレスに通知メールが届きます。</p>
        <p>このチュートリアルでは、GoogleのGAS(Google Apps Script)の設定方法を紹介します<br>
設定はPCで実施いただく事を推奨しています。スマホでは画面が小さいため入力が難しいです。
</p>

        <div class="step">
            <h2>0. 事前準備</h2>
            <ul>
                <li><strong>Googleアカウント</strong>（持っていない人は <a href="https://accounts.google.com/signup" target="_blank">ここから無料で作成</a> してね！）</li>
                <li><strong>DMM英会話の講師番号</strong></li>
            </ul>
            <p style="font-size: 0.9em; color: #666;">※講師番号は講師のプロフィールページのURLの一番最後にある数字です。下の画像を参考にしてね</p>
            <img src="step0_teacher_id.png" alt="講師番号の確認方法">
        </div>

        <div class="step">
            <h2>1. スプレッドシートを準備する</h2>
            <p>まずは、データを記録する「台帳」を作ります。</p>
            <p class="pink-text">【スプレッドシートの開き方】<br>
            Googleの画面右上にある「点々のマーク」から、緑色の<strong>「スプレッドシート」</strong>を選んでね。</p>
            <img src="step1_where_spreadsheet.png" alt="スプレッドシートの開き方">
            <p>開いたら「空白（＋マーク）」を押して新しいシートを作ります。</p>
            <img src="step1_spreadsheet.png" alt="スプレッドシートの開き方２">
            <p class="pink-text">※シートには何も書かなくて大丈夫。</p>
        </div>

        <div class="step">
            <h2>2. プログラムを貼り付ける</h2>
            <p>1. スプレッドシートのメニューから「拡張機能」→「Apps Script」を選んでクリック。</p>
            <img src="extend2.png" alt="GASの開き方">
            <p>2. GASの画面が開きます。</p>
            <img src="gas.png" alt="GASの画面">
            <p>3. 元から書いてある文字を全部消します。</p>
            <img src="gas_delete.png" alt="GASの画面">
            <p>4. 下の「コードをコピーする📝」ボタンを押して、GASのコードをコピーします。</p>
            <button class="copy-btn" onclick="copyGasCode()">コードをコピーする 📋</button>
            <p>5. GASに貼り付けます（ショートカット：Ctrl + V）。</p>
            <img src="gas_paste.png" alt="GASの画面">
      

        </div>

        <div class="step">
            <h2>3. プログラムの「初期設定」をする</h2>
            <p>1.コードを保存します。フロッピーの形のボタンをクリック。</p>
            <img src="save.png" alt="GASのコードを保存するボタン">
            <p>2.「デバッグ」の右隣にあるメニューから <code>setup</code> を選んで、「実行」ボタンを押す。</p>
                  
            <img src="gas_setup_select.png" alt="setup関数の選択">
            
            <p class="pink-text">⚠️ ここで「承認が必要」という画面が出たら：</p>
            <img src="auth.png" alt="承認が必要">        
            <p>権限を確認 → 自分のアカウント → 詳細 → 安全ではないページに移動 → 全て選択 → 続行の順にクリックしてね。</p>
            
            <p class="pink-text">※自分で作ったプログラムだから安全です！怖がらないで大丈夫。</p>
            
            <p>①自分のアカウントを選択。</p>
            <img src="select_your_account.png" alt="自分のアカウントを選択">
            <p>②「詳細」をクリック。</p>
            <img src="detail.png" alt="詳細をクリック">
            <p>③「（安全ではないページ）に移動」をクリック。</p>
            <img src="click_your_account.png" alt="無題のプロジェクト（安全ではないページ）に移動をクリック">
            <p>④ポップアップで小さな別ウィンドウが表示されます。</p>
            <img src="box.png" alt="小さな別ウィンドウが表示される">
            <p>⑤権限を付与する（すべてにチェックを入れて続行）。</p>
            <img src="allcheck.png" alt="小さな別ウィンドウが表示される">
            <p>⑥「続行」をクリック。</p>
            <img src="continue.png" alt="続行をクリック">
            <p>⑦GASの画面でプログラムが実行開始されます。</p>
            <img src="startrun.png" alt="GASの実行が開始されます">
            <p>⑧スプレッドシートのタブに移動します。</p>
            <img src="tospreadsheet.png" alt="スプレッドシートに移動">
            <p>⑨「準備完了~」の表示が出ているのでOKをクリックします。</p>
            <img src="pink.png" alt="スプレッドシートに移動">
        </div>

        <div class="step">
            <h2>4. 講師とメールアドレスを登録する</h2>
            <p>1. スプレッドシートの<strong>B1セル</strong>に、通知を受け取りたい<strong>「メールアドレス」</strong>を入力します。</p>
            <img src="mailad.png" alt="メールアドレス入力">
            <p>2. A列の<strong>5行目（A5セル）</strong>から下に、監視したい<strong>「講師番号」</strong>を入力します。</p>
            <img src="input2.png" alt="講師番号入力">
            <p class="pink-text">⚠️ 【大切なお願い】</p>
            <p>登録する講師は、<strong>最大20名まで</strong>にして下さい。サイトへのアクセスが多すぎると制限がかかりエラーになる場合があるためです。</p>      
        </div>

        <div class="step">
            <h2>7. 定期自動監視を設定する</h2>
            <p>最後にプログラムが自動で動くようにタイマーをセットします。</p>
            <p>1. GASの画面に戻って、今度は <code>setupTrigger</code> を選択。</p>
            <img src="run2.png" alt="setupTriggerを選択している様子">
            <p>2. <strong>「▷ 実行」</strong>ボタンを押します。</p>
            <p class="pink-text">✨ これで設定完了！</p>
            <p>実行ログに「⏰ 定期監視を開始しました。」と出れば成功です！ブラウザを閉じても大丈夫。<br>
一度定期監視を設定すれば、以降はこのスプレッドシートを開き、講師番号を追加・修正・削除するだけで講師の登録・削除ができます。GASの画面を触る必要はありません。
</p>
            <img src="log.png" alt="実行ログの様子">
            <p class="pink-text">【スプレッドシートに名前を付けよう！】<br>
<p>※無題のままでも問題はありませんが、名前を付けておくと後でGoogleドライブから探しやすくなります。</p>
</p>
            <img src="step1_spreadsheet_name.png" alt="名前を付けて準備完了">
            <p>「pamoka_gas」に名前を変えてみました。</p>
           <img src="pamoka_gas.png" alt="名前が変わったところ">
            <p>再度開きたい時、該当のスプレッドシートがすぐ見つけられます。</p>
           <img src="tofind.png" alt="名前が変わったところ">
        </div>

        <div class="step">
            <h2>番外編：監視を止めたいときは？</h2>
            <p>「もう通知はいらない」という時は、GAS画面の左にある<strong>時計マーク（トリガー）</strong>を押して、設定されているトリガーをゴミ箱マークで消します。</p>
            <img src="trigger_button.png" alt="トリガーボタン">
            <p>右端の3つの点をクリックします。</p>
            <img src="trigger1.png" alt="トリガーの設定表示">
            <p>「トリガーを削除」を選択します。</p>
            <img src="trigger2.png" alt="トリガーを削除">
            <p>講師を1人だけ消したい・トリガーの削除はややこしそうだからやりたくない、等という場合はスプレッドシートから講師番号を削除するだけでも監視は止まります。<br>
A列を消す場合は、B列・C列も合わせて削除してください(誤作動防止)。
</p>
           <p class="pink-text">※⚠️ 注意！スプレッドシートを削除するだけでは、自動監視（タイマー）は止まりません！ そのままにすると「エラーが発生しました」というメールが毎日届くようになってしまいます。 必ずトリガーを削除してから、シートを削除してください。</p> 
        </div>

        <footer>
            Created by pamoka
        </footer>
    </div>

    <textarea id="gasCodeHidden" style="position: absolute; left: -9999px;">
/**
 * DMM英会話 予約監視スクリプト (pamoka版)
 * スプレッドシートのB1にメール、A5から講師番号を入力してください。
 */

function setup() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
  
  // シートを一度リセット
  sheet.clear();
  sheet.clearConditionalFormatRules();
  
  // 列の幅を調整
  sheet.setColumnWidth(1, 250); // 講師番号
  sheet.setColumnWidth(2, 300); // 講師名
  sheet.setColumnWidth(3, 150); // 予約可数

  // 1行目：メールアドレス設定
  sheet.getRange("A1").setValue("通知用メールアドレスを入力 →").setBackground("#e8f5e9").setFontWeight("bold");
  const emailCell = sheet.getRange("B1");
  emailCell.setValue("【ここにメールアドレスを入力】");
  emailCell.setBackground("#fff0f0");
  emailCell.setFontColor("#d32f2f");
  emailCell.setBorder(true, true, true, true, false, false, "#d32f2f", SpreadsheetApp.BorderStyle.SOLID_MEDIUM);

  sheet.getRange("A2").setValue("※赤枠内(B1セル)に入力したアドレスに通知が届きます。5行目以下に講師番号を入れて下さい。").setFontColor("#666").setFontSize(9);

  // 4行目：見出し
  sheet.getRange("A4:C4").setValues([["講師番号を入力", "講師名（自動入力）", "現在の予約可数（自動入力）"]]);
  sheet.getRange("A4:C4").setBackground("#2e7d32").setFontColor("white").setFontWeight("bold");
  
  // 入力可能エリア（A5:A24 まで20人分）
  const inputRange = sheet.getRange("A5:A24");
  inputRange.setBackground("#f9f9f9").setBorder(true, true, true, true, false, false, "#ccc", SpreadsheetApp.BorderStyle.DOTTED);

  // --- 20人制限の設定（エラー修正版） ---
  const maxRows = sheet.getMaxRows();
  sheet.getRange(25, 1, maxRows - 24, 3).setBackground("#dcdcdc");
  sheet.getRange("A25").setValue("↑ 登録上限は20名です。これ以降の行は使用できません ↑").setFontColor("#999").setFontStyle("italic");
  
  // 修正ポイント：withFormula1 を使わずに「特定の文字以外はエラー」にする手法に変更
  const rule = SpreadsheetApp.newDataValidation()
    .requireTextEqualTo("上限は20名までです") 
    .setAllowInvalid(false)
    .setHelpText("講師の登録上限は20名です。これ以上の登録は動作の安定性を損なう可能性があるため制限されています。")
    .build();
  sheet.getRange(25, 1, maxRows - 24, 1).setDataValidation(rule);

  Browser.msgBox("セットアップが完了しました。\n\nピンク色の枠に通知用メールアドレスを入力し、5行目から講師番号を入力してください。\n※登録上限は20名に制限されています。");
}




function checkTeacherAvailability() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
  const email = sheet.getRange("B1").getValue();
  
  if (!email || !email.includes("@")) return;

  const lastRow = sheet.getLastRow();
  if (lastRow < 5) return;

  const data = sheet.getRange(5, 1, lastRow - 4, 3).getValues();
  
  for (let i = 0; i < data.length; i++) {
    const teacherId = String(data[i][0]).trim();
    let teacherName = String(data[i][1]).trim();
    const lastCount = data[i][2] === "" ? null : Number(data[i][2]);
    
    if (!teacherId) continue;

    try {
      const url = "https://eikaiwa.dmm.com/teacher/index/" + teacherId + "/";
      const response = UrlFetchApp.fetch(url, {
        muteHttpExceptions: true,
        headers: { "User-Agent": "Mozilla/5.0" }
      });

      if (response.getResponseCode() !== 200) continue;
      const html = response.getContentText();

      // 名前取得＆「の講師詳細」を削除
      if (!teacherName || teacherName === "" || teacherName.includes("講師詳細")) {
        const titleMatch = html.match(/<title>([\s\S]*?)\s-\sDMM英会話<\/title>/i);
        if (titleMatch && titleMatch[1]) {
          teacherName = titleMatch[1].replace("の講師詳細", "").trim();
        } else {
          teacherName = "講師 " + teacherId;
        }
        sheet.getRange(i + 5, 2).setValue(teacherName);
      }

      const matches = html.match(/予約可/g);
      let currentCount = Math.max(0, (matches ? matches.length : 0) - 2);

      // 通知判定
      if (lastCount === null) {
        sendNotification(email, teacherId, teacherName, currentCount, true);
      } else if (currentCount > lastCount) {
        sendNotification(email, teacherId, teacherName, currentCount, false);
      }

      sheet.getRange(i + 5, 3).setValue(currentCount);
      Utilities.sleep(1000);

    } catch (e) { console.error(e); }
  }
}

function sendNotification(email, teacherId, teacherName, currentCount, isFirstTime) {
  let subject, message;
  if (isFirstTime) {
    subject = "【DMM通知】監視を開始しました（" + teacherName + "先生）";
    message = teacherName + "先生（ID:" + teacherId + "）の予約監視を開始しました。\n現在の空き状況：" + currentCount + "件\n\nhttps://eikaiwa.dmm.com/teacher/index/" + teacherId + "/";
  } else {
    subject = "【DMM通知】" + teacherName + "先生の空きが出ました";
    message = teacherName + "先生の予約枠が追加されました！\n現在の空き状況：" + currentCount + "件\n\n予約はこちら：\nhttps://eikaiwa.dmm.com/teacher/index/" + teacherId + "/";
  }
  GmailApp.sendEmail(email, subject, message);
}

function setupTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
  ScriptApp.newTrigger("checkTeacherAvailability").timeBased().everyMinutes(10).create();
Logger.log("⏰ 定期監視を開始しました。");
}
</textarea>

    <script>
        function copyGasCode() {
            const copyText = document.getElementById("gasCodeHidden");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            document.execCommand("copy");
            alert("コピーしました！Apps Scriptの画面に貼り付けてください。");
        }
    </script>
</body>
</html>
